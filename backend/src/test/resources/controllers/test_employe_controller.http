### =========================================================================
### 1. AUTHENTIFICATION
### =========================================================================

# @name loginAdmin
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "bob.admin",
  "password": "password123"
}
> {% client.global.set("admin_token", response.body.accessToken); %}

###

# @name loginRH
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "alice.rh",
  "password": "password123"
}
> {% client.global.set("rh_token", response.body.accessToken); %}

###

# @name loginEmploye
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "cathy.employe",
  "password": "password123"
}
> {% client.global.set("emp_token", response.body.accessToken); %}


### =========================================================================
### 2. GESTION DES PRIVILÈGES ET HIÉRARCHIE
### =========================================================================

### A. Promouvoir Cathy en RH (Nécessite ROLE_ADMIN)
# On utilise l'ID de Cathy (à vérifier selon votre seeder, supposons 3)
PATCH http://localhost:8080/api/employes/3/rh-privilege?status=true
Authorization: Bearer {{admin_token}}

> {%
    client.test("Promotion RH réussie", function() {
    client.assert(response.status === 200);
    });
%}

### B. Assigner Bob (Admin/Employé 1) comme manager de Cathy (Employé 3)
# Spécification 5 : Lien hiérarchique
PATCH http://localhost:8080/api/employes/3/referent?referentId=1
Authorization: Bearer {{admin_token}}

> {%
    client.test("Assignation du manager réussie", function() {
    client.assert(response.status === 200);
    });
%}


### =========================================================================
### 3. CONSULTATION ET VÉRIFICATION DES LIENS
### =========================================================================

### C. Vérifier mon profil (Cathy) et voir mon nouveau manager
GET http://localhost:8080/api/employes/me
Authorization: Bearer {{emp_token}}

> {%
    client.test("Vérification du référent dans le profil", function() {
    client.assert(response.status === 200);
    client.assert(response.body.referentId === 1, "Le manager devrait être Bob (ID 1)");
    client.assert(response.body.rhPrivilege === true, "Cathy devrait maintenant avoir le flag RH");
    });
%}

### D. Voir la liste des RH (Doit maintenant inclure Cathy)
GET http://localhost:8080/api/employes/rh
Authorization: Bearer {{admin_token}}

> {%
    client.test("Cathy apparaît dans la liste RH", function() {
    client.assert(response.status === 200);
    const names = response.body.map(it => it.username);
    client.assert(names.includes("cathy.employe"), "Cathy manque à l'appel");
    });
%}

### E. Bob (Admin) consulte ses recrues/subordonnés
# Bob est l'ID 1, il devrait voir Cathy dans ses recrues
GET http://localhost:8080/api/employes/1/recrues
Authorization: Bearer {{admin_token}}

> {%
    client.test("Bob voit Cathy dans son équipe", function() {
    client.assert(response.status === 200);
    client.assert(response.body.length > 0, "L'équipe ne devrait pas être vide");
    });
%}


### =========================================================================
### 4. TESTS DE SÉCURITÉ (CAS LIMITES)
### =========================================================================

### F. Sécurité : Un employé ne peut pas se promouvoir lui-même RH
PATCH http://localhost:8080/api/employes/3/rh-privilege?status=true
Authorization: Bearer {{emp_token}}

> {%
    client.test("Sécurité : Promotion interdite sans Admin", function() {
    client.assert(response.status === 403);
    });
%}

### G. Sécurité : Empêcher l'auto-référence (Manager de soi-même)
PATCH http://localhost:8080/api/employes/3/referent?referentId=3
Authorization: Bearer {{admin_token}}

> {%
    client.test("Erreur : On ne peut pas être son propre manager", function() {
    client.assert(response.status === 400 || response.status === 403);
    });
%}