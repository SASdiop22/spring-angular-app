### Variables Globales
@baseUrl = http://localhost:8080/api/applications
@authUrl = http://localhost:8080/api/auth

### 1. AUTHENTIFICATION
### -------------------------------------------------------------------------

# @name adminLogin
POST {{authUrl}}/login
Content-Type: application/json

{
  "username": "bob.admin",
  "password": "password123"
}
> {% client.global.set("admin_token", response.body.accessToken); %}

###

# @name loginRH
POST {{authUrl}}/login
Content-Type: application/json

{
  "username": "alice.rh",
  "password": "password123"
}
> {% client.global.set("token_rh", response.body.accessToken); %}

###

# @name loginPaul (Candidat)
POST {{authUrl}}/login
Content-Type: application/json

{
  "username": "paul.rejet",
  "password": "password123"
}
> {% client.global.set("token_paul", response.body.accessToken); %}

###

# @name loginPaul (Candidat)
POST {{authUrl}}/login
Content-Type: application/json

{
  "username": "sophie.onboard",
  "password": "password123"
}
> {% client.global.set("token_jean", response.body.accessToken); %}



### 2. INITIALISATION DES DONNÉES (RÉCUPÉRATION DES IDs)
### -------------------------------------------------------------------------

# @name getIds
GET http://localhost:8080/api/users
Authorization: Bearer {{admin_token}}

> {%
    var paul = response.body.find(u => u.username === "paul.rejet");
    var bob = response.body.find(u => u.username === "bob.admin");
    var jean = response.body.find(u => u.username === "sophie.onboard");
    client.global.set("paul_id", paul.id);
    client.global.set("bob_id", bob.id);
    client.global.set("jean_id", jean.id);
%}


### 3. TEST : POSTULER (SPEC 3.A)
### -------------------------------------------------------------------------

# @name applyAction
POST {{baseUrl}}/apply?jobOfferId=2&candidateId={{paul_id}}&cvUrl=http://storage.com/cv.pdf&coverLetter=Motivation
Authorization: Bearer {{token_paul}}

> {%
    client.test("Candidature réussie", function() {
        client.assert(response.status === 201, "Le statut devrait être 201 Created");
        client.global.set("current_app_id", response.body.id);
    });
%}


### 4. TEST : PLANIFIER UN ENTRETIEN (SPEC 4.A)
### -------------------------------------------------------------------------

# On utilise l'ID de Bob (Admin/Employé) comme interviewer
PATCH {{baseUrl}}/{{current_app_id}}/schedule-interview?date=2026-02-15T14:30:00&interviewerId={{bob_id}}&location=Bureau 402, Paris
Authorization: Bearer {{token_rh}}

> {%
    client.test("Entretien planifié avec succès", function() {
        client.assert(response.status === 200);
        client.assert(response.body.status === "INTERVIEW_PENDING");
    });
%}


### 5. TEST : VOIR SES PROPRES CANDIDATURES (SPEC 3.B)
### -------------------------------------------------------------------------

GET {{baseUrl}}/candidate/{{paul_id}}
Authorization: Bearer {{token_paul}}

> {%
    client.test("Le candidat voit sa liste", function() {
        client.assert(response.status === 200);
        client.assert(response.body.length > 0);
    });
%}


### 6. TEST : REJET AVEC MOTIF (SPEC 4.B)
### -------------------------------------------------------------------------

# @name applyAction
POST {{baseUrl}}/apply?jobOfferId=2&candidateId={{jean_id}}&cvUrl=http://storage.com/cv.pdf&coverLetter=Motivation
Authorization: Bearer {{token_jean}}

> {%
    client.test("Candidature réussie", function() {
        client.assert(response.status === 201, "Le statut devrait être 201 Created");
        client.global.set("jean_app_id", response.body.id);
    });
%}

###

# On utilise l'ID de Bob (Admin/Employé) comme interviewer
PATCH {{baseUrl}}/{{jean_app_id}}/schedule-interview?date=2026-02-15T14:30:00&interviewerId={{bob_id}}&location=Bureau 402, Paris
Authorization: Bearer {{token_rh}}

> {%
    client.test("Entretien planifié avec succès", function() {
        client.assert(response.status === 200);
        client.assert(response.body.status === "INTERVIEW_PENDING");
    });
%}

###

PATCH {{baseUrl}}/{{jean_app_id}}/status
Authorization: Bearer {{token_rh}}
Content-Type: application/json

{
  "status": "REJECTED",
  "reason": "Profil technique insuffisant pour le poste de Senior Developer"
}

> {%
    client.test("Rejet motivé enregistré", function() {
        client.assert(response.status === 200);
        client.assert(response.body.rejectionReason !== null);
    });
%}


### 7. TEST : FINALISATION EMBAUCHE (SPEC 5)
### -------------------------------------------------------------------------

# Note: On ré-applique ou on change le statut pour pouvoir embaucher (cas de succès)
# @name hireAction
POST {{baseUrl}}/{{current_app_id}}/hire
Authorization: Bearer {{admin_token}}

> {%
    client.test("Embauche finale réussie", function() {
        client.assert(response.status === 200, "L'embauche devrait être validée");
    });
%}


### 8. VÉRIFICATION FINALE (INTÉGRATION AVEC EMPLOYÉ)
### -------------------------------------------------------------------------

# Vérifier que Paul est maintenant un employé et a Bob comme référent
GET http://localhost:8080/api/employes/me
Authorization: Bearer {{token_paul}}

> {%
    client.test("Paul a maintenant un profil employé et un manager", function() {
        client.assert(response.status === 200);
        // Le manager devrait être le créateur de l'offre (Bob)
        client.assert(response.body.nomComplet !== null);
    });
%}