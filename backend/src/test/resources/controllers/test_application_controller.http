### Variables Globales
@baseUrl = http://localhost:8080/api/applications
@candidateId = 1
@jobOfferId = 1

# @name loginAdmin
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "bob.admin",
  "password": "password123"
}
> {% client.global.set("token_admin", response.body.accessToken); %}

###

# @name loginRH
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "alice.rh",
  "password": "password123"
}
> {% client.global.set("token_rh", response.body.accessToken); %}

###

# @name loginCandidat
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "jean.candidat",
  "password": "password123"
}
> {% client.global.set("token_candidat", response.body.accessToken); %}


### 1. Spécification 3.A : Un candidat postule
# Teste la création d'une candidature.
# Nécessite ROLE_CANDIDAT ou ROLE_ADMIN.
POST {{baseUrl}}/apply
    ?jobOfferId={{jobOfferId}}
    &candidateId={{candidateId}}
    &cvUrl=https://storage.cloud/mon-cv.pdf
    &coverLetter=Je suis très motivé par ce poste.
Authorization: Bearer {{token_candidat}}
Content-Type: application/json

> {% client.global.set("new_app", response.body.id);

    client.test("Request executed successfully", function() {
        client.assert(response.status === 201, "Le statut de réponse devrait être 201 (Created)");
    });
%}

### 2. Spécification 4.A : Liste globale des candidatures
# Récupère toutes les candidatures pour le pilotage RH.
# Nécessite ROLE_RH ou ROLE_ADMIN.
GET {{baseUrl}}
Authorization: Bearer {{token_rh}}
Accept: application/json

> {%
    client.test("RH access authorized", function() {
        client.assert(response.status === 200, "Le RH devrait pouvoir accéder à la liste");
        client.assert(Array.isArray(response.body), "La réponse devrait être un tableau");
    });
%}

### 3. Spécification 3.B : Voir ses propres candidatures
# Récupère les candidatures d'un candidat spécifique.
# Nécessite ROLE_ADMIN ou ROLE_CANDIDAT (avec vérification d'identité).
GET {{baseUrl}}/candidate/{{candidateId}}
Authorization: Bearer {{token_candidat}}
Accept: application/json

> {%
    client.test("Candidat access authorized", function() {
        client.assert(response.status === 200, "Le candidat devrait pouvoir voir ses candidatures");
    });
%}

### 4. Spécification 4.A & 5 : Mise à jour du statut (ex: Recrutement)
# Change le statut d'une candidature.
# Si passé à 'HIRED', l'offre doit passer en 'FILLED' dans le service.
# Nécessite ROLE_RH ou ROLE_ADMIN.
PATCH {{baseUrl}}/{{new_app}}/status?status=HIRED
Authorization: Bearer {{token_rh}}
Content-Type: application/json

> {%
    client.test("Status updated successfully", function() {
        client.assert(response.status === 200, "La requête a échoué");
        // Vérifiez si le champ est 'currentStatus' ou 'status'
        var status = response.body.currentStatus || response.body.status;
        client.assert(status === "HIRED", "Le statut reçu est : " + status);
    });
%}

### 5. Test de sécurité (Accès refusé)
# Tentative d'accès à la liste globale avec un rôle insuffisant (ex: Candidat).
GET {{baseUrl}}
Authorization: Bearer {{token_candidat}}
Accept: application/json

> {%
    client.test("Access denied for simple candidates", function() {
        client.assert(response.status === 403, "Un candidat ne doit pas voir toutes les candidatures");
    });
%}