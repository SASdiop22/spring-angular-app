### !!! TESTER CANDITAT AVANT APPLICATION !!!


### Variables Globales


@baseUrl = http://localhost:8080/api/applications
@jobOfferId = 3


# @name loginAdmin
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "bob.admin",
  "password": "password123"
}
> {% client.global.set("token_admin", response.body.accessToken); %}

###

# @name loginRH
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "alice.rh",
  "password": "password123"
}
> {% client.global.set("token_rh", response.body.accessToken); %}

###

# @name loginCandidat
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "sophie.onboard",
  "password": "password123"
}
> {% client.global.set("token_candidat", response.body.accessToken); %}

###
# @name getSophieId
GET http://localhost:8080/api/candidates/me
Authorization: Bearer {{token_candidat}}

> {%
    client.global.set("sophie_id", response.body.id);
%}


### 1. Spécification 3.A : Un candidat postule
# Teste la création d'une candidature.
# Nécessite ROLE_CANDIDAT ou ROLE_ADMIN.
POST {{baseUrl}}/apply?jobOfferId={{jobOfferId}}&candidateId={{sophie_id}}&cvUrl=http://moncv.com/sophie.pdf
Authorization: Bearer {{token_candidat}}
Content-Type: application/json

{
  "coverLetter": "Je suis très motivée par ce poste de Product Manager S3."
}

> {%
    client.global.set("new_app_id", response.body.id);

    client.test("Candidature créée avec succès", function() {
        client.assert(response.status === 201, "Le statut devrait être 201 Created");
        client.global.set("new_app_id", response.body.id);
    });
%}

### 2. Récupérer toutes les candidatures (Vue RH)
# Route : GET /api/applications
# Nécessite ROLE_RH ou ROLE_ADMIN.
GET {{baseUrl}}
Authorization: Bearer {{token_rh}}
Accept: application/json

> {%
    client.test("RH peut voir la liste globale", function() {
        client.assert(response.status === 200, "Accès refusé au RH");
        client.assert(response.body.length > 0, "La liste ne devrait pas être vide");
    });
%}

### 3. Spécification 3.B : Un candidat voit ses propres candidatures
# Route : GET /api/applications/candidate/{id}
# Vérifie la sécurité (isApplicationOwner) via le SecurityService.
GET {{baseUrl}}/candidate/{{sophie_id}}
Authorization: Bearer {{token_candidat}}
Accept: application/json

> {%
    client.test("Candidat voit ses propres données", function() {
        client.assert(response.status === 200, "Le candidat devrait accéder à ses données");
    });
%}

### 4. Spécification 4.A & 5 : Mise à jour du statut vers HIRED (Recrutement)
# Si passé à 'HIRED', l'offre passe automatiquement en 'FILLED' dans le service.
PATCH {{baseUrl}}/{{new_app_id}}/status?status=HIRED
Authorization: Bearer {{token_rh}}
Content-Type: application/json

> {%
    client.test("Statut mis à jour vers HIRED", function() {
        client.assert(response.status === 200, "Échec de la mise à jour");
        client.assert(response.body.status === "HIRED", "Le statut n'est pas HIRED");
    });
%}

### 5. Spécification 4.B : Rejet d'une candidature avec motif
# On teste ici le paramètre optionnel 'reason' (rejectionReason).
PATCH {{baseUrl}}/{{new_app_id}}/status?status=REJECTED&reason=Manque d'expérience sur Angular
Authorization: Bearer {{token_rh}}
Content-Type: application/json

> {%
    client.test("Rejet avec motif pris en compte", function() {
        client.assert(response.status === 200, "Échec du rejet");
        client.assert(response.body.rejectionReason === "Manque d'expérience sur Angular", "Motif non enregistré");
    });
%}

### 6. Test de Sécurité : Un candidat essaie de voir la liste globale
# Doit retourner 403 Forbidden.
GET {{baseUrl}}
Authorization: Bearer {{token_candidat}}
Accept: application/json

> {%
    client.test("Accès interdit aux candidats pour la liste globale", function() {
        client.assert(response.status === 403, "Un candidat ne doit pas voir toutes les candidatures");
    });
%}