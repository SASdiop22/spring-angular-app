### =========================================================================
### 1. AUTHENTIFICATION DES ACTEURS
### =========================================================================

# @name loginRH
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "alice.rh",
  "password": "password123"
}
> {% client.global.set("token_rh", response.body.accessToken); %}

###

# @name loginManager
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "dylan.demandeur",
  "password": "password123"
}
> {% client.global.set("token_manager", response.body.accessToken); %}

###

# @name loginCandidat
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "sophie.onboard",
  "password": "password123"
}
> {% client.global.set("token_sophie", response.body.accessToken); %}


### =========================================================================
### 2. PRÉPARATION DYNAMIQUE (RECHERCHE D'UNE OFFRE ET CANDIDATURE)
### =========================================================================

# @name getJob
GET http://localhost:8080/api/joboffers
Authorization: Bearer {{token_rh}}

> {%
    const job = response.body.find(o => o.status === "OPEN");
    client.global.set("job_id", job.id);
    // On récupère l'ID utilisateur de Sophie via son login pour postuler
    client.global.set("sophie_id", 6);
%}

### 3. ACTION : Sophie postule
POST http://localhost:8080/api/applications/apply?jobOfferId={{job_id}}&candidateId={{sophie_id}}&cvUrl=http://cloud.com/cv-sophie.pdf
Authorization: Bearer {{token_sophie}}

> {%
    client.test("Candidature créée", function() {
        client.assert(response.status === 201 || response.status === 200);
        client.global.set("current_app_id", response.body.id);
    });
%}


### =========================================================================
### 4. JOURNALISATION : AJOUT DE NOTES (SPEC 4.B)
### =========================================================================

### 4a. Note du RH (Alice)
POST http://localhost:8080/api/applications/{{current_app_id}}/notes
Authorization: Bearer {{token_rh}}
Content-Type: application/json

{
  "stepName": "Tri initial",
  "content": "Profil intéressant, bonnes compétences Kubernetes. À valider techniquement."
}

> {%
    client.test("Note RH enregistrée", function() {
        client.assert(response.status === 201 || response.status === 200);
    });
%}

### 4b. Note du Manager (Dylan)
POST http://localhost:8080/api/applications/{{current_app_id}}/notes
Authorization: Bearer {{token_manager}}
Content-Type: application/json

{
  "stepName": "Entretien Technique",
  "content": "Excellent niveau technique. Candidat très motivé."
}

### =========================================================================
### 5. VÉRIFICATION DE LA TRAÇABILITÉ ET CONFIDENTIALITÉ
### =========================================================================

### 5. VÉRIFICATION : Le RH consulte le journal complet
GET http://localhost:8080/api/applications/{{current_app_id}}
Authorization: Bearer {{token_rh}}

> {%
    client.test("Traçabilité : Le journal contient les notes des deux acteurs", function() {
        client.assert(response.body.notes.length >= 2, "Il devrait y avoir au moins 2 notes");

        // Vérification de la présence des auteurs
        const hasAlice = response.body.notes.some(n => n.authorName.includes("alice"));
        const hasDylan = response.body.notes.some(n => n.authorName.includes("dylan"));

        client.assert(hasAlice, "La note d'Alice RH doit être présente");
        client.assert(hasDylan, "La note de Dylan Manager doit être présente");
    });
%}


### =========================================================================
### 6. ÉTAPE FINALE : REJET AVEC MOTIF (OBLIGATOIRE SPEC 4.B)
### =========================================================================

### 6a. Le RH rejette la candidature avec un motif
PATCH http://localhost:8080/api/applications/{{current_app_id}}/status
Authorization: Bearer {{token_rh}}
Content-Type: application/json

{
  "status": "REJECTED",
  "reason": "Prétentions salariales trop élevées pour le budget actuel."
}

> {%
    client.test("Rejet avec motif validé", function() {
        client.assert(response.status === 200);
        client.assert(response.body.status === "REJECTED");
        client.assert(response.body.rejectionReason !== null, "Le motif de rejet doit être enregistré");
    });
%}