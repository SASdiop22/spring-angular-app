### =========================================================================
### 1. AUTHENTIFICATION
### =========================================================================

# @name loginRH
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "alice.rh",
  "password": "password123"
}
> {% client.global.set("token_rh", response.body.accessToken); %}

###

# @name loginCandidat
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "username": "paul.rejet",
  "password": "password123"
}
> {% client.global.set("token_paul", response.body.accessToken); %}

### =========================================================================
### 2. CRÉATION DYNAMIQUE (Pour éviter le "Candidature introuvable")
### =========================================================================

# @name applyAction
POST http://localhost:8080/api/applications/apply?jobOfferId=1&candidateId=6&cvUrl=http://cloud.storage/cv_test.pdf
Authorization: Bearer {{token_paul}}

> {%
    client.global.set("app_id_dynamique", response.body.id);
    client.log("Nouvel ID créé pour le test : " + response.body.id);
%}

### =========================================================================
### 3. TESTS DE ROBUSTESSE (SPEC 4.B)
### =========================================================================

### 3a. ÉCHEC VOLONTAIRE : Rejet SANS motif
# On utilise l'ID que l'on vient de créer dynamiquement
PATCH http://localhost:8080/api/applications/{{app_id_dynamique}}/status
Authorization: Bearer {{token_rh}}
Content-Type: application/json

{
  "status": "REJECTED"
}

> {%
    client.test("Validation : Le rejet sans motif doit retourner une erreur", function() {
        // On attend une erreur 400 ou 500 selon votre gestion d'exception
        client.assert(response.status >= 400, "Le serveur n'aurait pas dû accepter un rejet sans motif");
    });
%}

### 3b. SUCCÈS : Rejet AVEC motif obligatoire
PATCH http://localhost:8080/api/applications/{{app_id_dynamique}}/status
Authorization: Bearer {{token_rh}}
Content-Type: application/json

{
  "status": "REJECTED",
  "reason": "Profil trop junior pour les exigences du poste (Java/Spring)."
}

> {%
    client.test("Le rejet avec motif fonctionne", function() {
        client.assert(response.status === 200, "Le rejet devrait être validé");
        client.assert(response.body.status === "REJECTED");
        client.assert(response.body.rejectionReason !== null, "Le motif doit être enregistré");
    });
%}

### =========================================================================
### 4. TEST DE SÉCURITÉ : ACCÈS INEXISTANT
### =========================================================================

### 4a. Vérification de l'erreur 404
GET http://localhost:8080/api/applications/9999
Authorization: Bearer {{token_rh}}

> {%
    client.test("L'accès à un ID inexistant renvoie 404", function() {
        client.assert(response.status === 404);
    });
%}