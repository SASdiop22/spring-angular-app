### =========================================================================
### 1. AUTHENTIFICATION DES ACTEURS
### =========================================================================

# @name loginDemandeur
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{ "username": "dylan.demandeur", "password": "password123" }
> {% client.global.set("token_demandeur", response.body.accessToken); %}

###

# @name loginRH
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{ "username": "alice.rh", "password": "password123" }
> {% client.global.set("token_rh", response.body.accessToken); %}

### =========================================================================
### 2. CRÉATION DE LA DEMANDE (SPEC 2.A)
### =========================================================================

# @name createOffer
POST http://localhost:8080/api/joboffers
Authorization: Bearer {{token_demandeur}}
Content-Type: application/json

{
  "title": "Ingénieur DevOps Cloud",
  "description": "Expert Azure et Kubernetes pour l'équipe infrastructure.",
  "departement": "IT"
}

> {%
    client.test("L'offre est créée en statut PENDING", function() {
        client.assert(response.status === 201, "L'offre devrait être créée (201)");
        client.assert(response.body.status === "DRAFT", "Le statut initial doit être DRAFT");
        client.global.set("new_offer_id", response.body.id);
    });
%}


### =========================================================================
### 3. TESTS DE SÉCURITÉ ET CONFIDENTIALITÉ (SPEC 2.B)
### =========================================================================

### 3a. VÉRIFICATION : L'offre PENDING n'est pas publique
GET http://localhost:8080/api/joboffers
# Sans authentification ou avec un compte Candidat (optionnel ici)

> {%
    client.test("L'offre en attente est invisible au public", function() {
        var offers = response.body;
        var found = offers.find(o => o.id === client.global.get("new_offer_id"));
        client.assert(!found, "L'offre PENDING ne doit pas apparaître dans la liste publique");
    });
%}

### 3b. ÉCHEC : Le manager tente de publier lui-même (Interdit)
PATCH http://localhost:8080/api/joboffers/{{new_offer_id}}/publish?salary=80000&remoteDays=2
Authorization: Bearer {{token_demandeur}}

> {%
    client.test("Le manager ne peut pas publier", function() {
        client.assert(response.status === 403, "Seul le RH peut publier l'offre (403 attendu)");
    });
%}

### =========================================================================
### 4. ENRICHISSEMENT ET PUBLICATION PAR LE RH (SPEC 2.B)
### =========================================================================

# @name publishOffer
PATCH http://localhost:8080/api/joboffers/{{new_offer_id}}/publish?salary=72000&remoteDays=3
Authorization: Bearer {{token_rh}}

> {%
    client.test("Le RH publie l'offre avec succès", function() {
        client.assert(response.status === 200, "La publication devrait réussir");
        client.assert(response.body.status === "OPEN", "Le statut doit passer à OPEN");
        client.assert(response.body.salaryRange === 72000);
    });
%}

### =========================================================================
### 5. VÉRIFICATION FINALE
### =========================================================================

### 5a. L'offre est maintenant visible publiquement
GET http://localhost:8080/api/joboffers

> {%
    client.test("L'offre OPEN est visible", function() {
        var found = response.body.find(o => o.id === client.global.get("new_offer_id"));
        client.assert(found !== undefined, "L'offre doit maintenant être visible");
        client.assert(found.status === "OPEN");
    });
%}
